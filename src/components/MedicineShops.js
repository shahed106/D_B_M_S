import React, { useState } from 'react';
import './MedicineShops.css';

function MedicineShops({ prescription, language = 'bn', onGoBack, onShopSelected }) {
  const t = {
    bn: {
      title: 'ржУрж╖рзБржзрзЗрж░ ржжрзЛржХрж╛ржи ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи',
      subtitle: 'ржЖржкржирж╛рж░ ржПрж▓рж╛ржХрж╛рж░ ржирж┐рж░рзНржнрж░ржпрзЛржЧрзНржп ржУрж╖рзБржзрзЗрж░ ржжрзЛржХрж╛ржи ржерзЗржХрзЗ ржЕрж░рзНржбрж╛рж░ ржХрж░рзБржи',
      prescriptionInfo: 'ржкрзНрж░рзЗрж╕ржХрзНрж░рж┐ржкрж╢ржи рждржерзНржп',
      availableShops: 'ржЙржкрж▓ржмрзНржз ржжрзЛржХрж╛ржирж╕ржорзВрж╣',
      selectShop: 'ржжрзЛржХрж╛ржи ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи',
      shopDetails: 'ржжрзЛржХрж╛ржирзЗрж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд',
      rating: 'рж░рзЗржЯрж┐ржВ',
      location: 'ржЕржмрж╕рзНржерж╛ржи',
      deliveryTime: 'ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ рж╕ржоржпрж╝',
      medicines: 'ржУрж╖рзБржзрж╕ржорзВрж╣',
      quantity: 'ржкрж░рж┐ржорж╛ржг',
      price: 'ржжрж╛ржо',
      total: 'ржорзЛржЯ',
      available: 'ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржЪрзНржЫрзЗ',
      notAvailable: 'ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржЪрзНржЫрзЗ ржирж╛',
      proceedToOrder: 'ржЕрж░рзНржбрж╛рж░ ржХрж░рзБржи',
      back: 'ржлрж┐рж░рзЗ ржпрж╛ржи',
      subtotal: 'ржЙржкржорзЛржЯ',
      deliveryCharge: 'ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржЪрж╛рж░рзНржЬ',
      grandTotal: 'рж╕рж░рзНржмржорзЛржЯ',
      selectToOrder: 'ржЕрж░рзНржбрж╛рж░ ржХрж░рж╛рж░ ржЬржирзНржп ржжрзЛржХрж╛ржи ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи',
      contact: 'ржпрзЛржЧрж╛ржпрзЛржЧ'
    },
    en: {
      title: 'Select Medicine Shop',
      subtitle: 'Order from trusted medicine shops in your area',
      prescriptionInfo: 'Prescription Info',
      availableShops: 'Available Shops',
      selectShop: 'Select Shop',
      shopDetails: 'Shop Details',
      rating: 'Rating',
      location: 'Location',
      deliveryTime: 'Delivery Time',
      medicines: 'Medicines',
      quantity: 'Quantity',
      price: 'Price',
      total: 'Total',
      available: 'Available',
      notAvailable: 'Not Available',
      proceedToOrder: 'Proceed to Order',
      back: 'Back',
      subtotal: 'Subtotal',
      deliveryCharge: 'Delivery Charge',
      grandTotal: 'Grand Total',
      selectToOrder: 'Select a shop to place order',
      contact: 'Contact'
    }
  }[language];

  // Mock medicine shops data
  const medicineShops = [
    {
      id: 1,
      name: 'рж╕рзНржмрж╛рж╕рзНржерзНржп ржлрж╛рж░рзНржорзЗрж╕рж┐',
      location: 'ржзрж╛ржиржоржирзНржбрж┐, ржврж╛ржХрж╛',
      rating: 4.8,
      deliveryTime: 'рзи-рзк ржШржирзНржЯрж╛',
      contact: '01711-234567',
      image: 'ЁЯПк',
      deliveryCharge: 50,
      medicines: [
        { name: 'Paracetamol', price: 8, available: true },
        { name: 'Amoxicillin', price: 120, available: true },
        { name: 'Metformin', price: 95, available: false },
        { name: 'Aspirin', price: 15, available: true }
      ]
    },
    {
      id: 2,
      name: 'рж▓рж╛ржЬрзБржХ ржлрж╛рж░рзНржорзЗрж╕рж┐',
      location: 'ржЧрзБрж▓рж╢рж╛ржи, ржврж╛ржХрж╛',
      rating: 4.9,
      deliveryTime: 'рзз-рзй ржШржирзНржЯрж╛',
      contact: '01811-345678',
      image: 'ЁЯТК',
      deliveryCharge: 60,
      medicines: [
        { name: 'Paracetamol', price: 10, available: true },
        { name: 'Amoxicillin', price: 115, available: true },
        { name: 'Metformin', price: 90, available: true },
        { name: 'Aspirin', price: 18, available: true }
      ]
    },
    {
      id: 3,
      name: 'ржХрзГрж╖ржХ ржлрж╛рж░рзНржорзЗрж╕рж┐',
      location: 'ржорж┐рж░ржкрзБрж░, ржврж╛ржХрж╛',
      rating: 4.6,
      deliveryTime: 'рзй-рзл ржШржирзНржЯрж╛',
      contact: '01911-456789',
      image: 'ЁЯМ┐',
      deliveryCharge: 40,
      medicines: [
        { name: 'Paracetamol', price: 7, available: true },
        { name: 'Amoxicillin', price: 125, available: false },
        { name: 'Metformin', price: 100, available: true },
        { name: 'Aspirin', price: 12, available: true }
      ]
    },
    {
      id: 4,
      name: 'рж╣рзЗрж▓рже ржкрзНрж▓рж╛рж╕ ржлрж╛рж░рзНржорзЗрж╕рж┐',
      location: 'ржмржирж╛ржирзА, ржврж╛ржХрж╛',
      rating: 4.7,
      deliveryTime: 'рзи-рзк ржШржирзНржЯрж╛',
      contact: '01611-567890',
      image: 'ЁЯПе',
      deliveryCharge: 55,
      medicines: [
        { name: 'Paracetamol', price: 9, available: true },
        { name: 'Amoxicillin', price: 110, available: true },
        { name: 'Metformin', price: 85, available: true },
        { name: 'Aspirin', price: 16, available: true }
      ]
    }
  ];

  const [selectedShop, setSelectedShop] = useState(null);
  const [medicineQuantities, setMedicineQuantities] = useState({});

  // Initialize quantities
  React.useEffect(() => {
    if (prescription && prescription.medicines) {
      const quantities = {};
      prescription.medicines.forEach((med, idx) => {
        quantities[med.name] = 1;
      });
      setMedicineQuantities(quantities);
    }
  }, [prescription]);

  const handleQuantityChange = (medicineName, quantity) => {
    setMedicineQuantities(prev => ({
      ...prev,
      [medicineName]: Math.max(1, parseInt(quantity) || 1)
    }));
  };

  const getMedicinePrice = (shopId, medicineName) => {
    const shop = medicineShops.find(s => s.id === shopId);
    const medicine = shop?.medicines.find(m => m.name === medicineName);
    return medicine?.price || 50; // Default price if not found
  };

  const isMedicineAvailable = (shopId, medicineName) => {
    const shop = medicineShops.find(s => s.id === shopId);
    const medicine = shop?.medicines.find(m => m.name === medicineName);
    return medicine?.available || false;
  };

  const calculateSubtotal = (shopId) => {
    if (!prescription?.medicines) return 0;
    let total = 0;
    prescription.medicines.forEach(med => {
      const price = getMedicinePrice(shopId, med.name);
      const quantity = medicineQuantities[med.name] || 1;
      total += price * quantity;
    });
    return total;
  };

  const calculateGrandTotal = (shopId) => {
    const shop = medicineShops.find(s => s.id === shopId);
    const subtotal = calculateSubtotal(shopId);
    const deliveryCharge = shop?.deliveryCharge || 50;
    return subtotal + deliveryCharge;
  };

  const handleProceedToOrder = () => {
    if (!selectedShop) {
      alert(language === 'bn' ? 'ржжрзЛржХрж╛ржи ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи' : 'Please select a shop');
      return;
    }

    const orderData = {
      shop: selectedShop,
      prescription: prescription,
      medicines: prescription.medicines.map(med => ({
        ...med,
        quantity: medicineQuantities[med.name] || 1,
        price: getMedicinePrice(selectedShop.id, med.name),
        total: (medicineQuantities[med.name] || 1) * getMedicinePrice(selectedShop.id, med.name),
        available: isMedicineAvailable(selectedShop.id, med.name)
      })),
      subtotal: calculateSubtotal(selectedShop.id),
      deliveryCharge: selectedShop.deliveryCharge,
      grandTotal: calculateGrandTotal(selectedShop.id)
    };

    onShopSelected(orderData);
  };

  return (
    <div className="medicine-shops">
      <div className="shops-header">
        <button className="back-btn" onClick={onGoBack}>
          тЖР {t.back}
        </button>
        <h1>ЁЯПк {t.title}</h1>
        <p className="subtitle">{t.subtitle}</p>
      </div>

      <div className="shops-content">
        {/* Prescription Info */}
        <div className="prescription-info-card">
          <h3>ЁЯУЛ {t.prescriptionInfo}</h3>
          <div className="prescription-summary">
            <div><strong>ржкрзНрж░рзЗрж╕ржХрзНрж░рж┐ржкрж╢ржи ржиржВ:</strong> {prescription?.prescriptionNo}</div>
            <div><strong>ржбрж╛ржХрзНрждрж╛рж░:</strong> {prescription?.doctorName}</div>
            <div><strong>рждрж╛рж░рж┐ржЦ:</strong> {prescription?.date}</div>
          </div>
        </div>

        {/* Available Shops */}
        <div className="shops-section">
          <h3>ЁЯПк {t.availableShops}</h3>
          <div className="shops-grid">
            {medicineShops.map(shop => {
              const isSelected = selectedShop?.id === shop.id;
              const grandTotal = calculateGrandTotal(shop.id);
              
              return (
                <div 
                  key={shop.id} 
                  className={`shop-card ${isSelected ? 'selected' : ''}`}
                  onClick={() => setSelectedShop(shop)}
                >
                  <div className="shop-header">
                    <div className="shop-icon">{shop.image}</div>
                    <div className="shop-info">
                      <h4>{shop.name}</h4>
                      <div className="shop-meta">
                        <span>ЁЯУН {shop.location}</span>
                        <span>тнР {shop.rating}</span>
                      </div>
                    </div>
                  </div>

                  <div className="shop-details">
                    <div className="detail-item">
                      <span>ЁЯЪЪ {t.deliveryTime}:</span>
                      <span>{shop.deliveryTime}</span>
                    </div>
                    <div className="detail-item">
                      <span>ЁЯУЮ {t.contact}:</span>
                      <span>{shop.contact}</span>
                    </div>
                    <div className="detail-item">
                      <span>ЁЯТ░ {t.deliveryCharge}:</span>
                      <span>рз│{shop.deliveryCharge}</span>
                    </div>
                  </div>

                  {/* Medicine Availability */}
                  <div className="medicines-availability">
                    <h5>ЁЯТК {t.medicines}</h5>
                    {prescription?.medicines?.map((med, idx) => {
                      const available = isMedicineAvailable(shop.id, med.name);
                      const price = getMedicinePrice(shop.id, med.name);
                      return (
                        <div key={idx} className="medicine-availability-item">
                          <span className="med-name">{med.name}</span>
                          <span className={`availability ${available ? 'available' : 'unavailable'}`}>
                            {available ? `тЬЕ рз│${price}` : 'тЭМ рж╕рзНржЯржХрзЗ ржирзЗржЗ'}
                          </span>
                        </div>
                      );
                    })}
                  </div>

                  <div className="shop-total">
                    <div className="total-info">
                      <div>ржорзЛржЯ: рз│{grandTotal}</div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* Selected Shop Details */}
        {selectedShop && (
          <div className="selected-shop-section">
            <h3>ЁЯЫТ {selectedShop.name} - ржЕрж░рзНржбрж╛рж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд</h3>
            <div className="order-details-card">
              <div className="medicines-list">
                {prescription?.medicines?.map((med, idx) => {
                  const price = getMedicinePrice(selectedShop.id, med.name);
                  const available = isMedicineAvailable(selectedShop.id, med.name);
                  const quantity = medicineQuantities[med.name] || 1;
                  
                  return (
                    <div key={idx} className="medicine-order-row">
                      <div className="medicine-info">
                        <div className="medicine-name">{med.name}</div>
                        <div className="medicine-prescription">
                          <small>ржорж╛рждрзНрж░рж╛: {med.dosage} | рж╕ржоржпрж╝ржХрж╛рж▓: {med.duration}</small>
                        </div>
                      </div>
                      
                      {available ? (
                        <div className="medicine-controls">
                          <div className="quantity-control">
                            <label>ржкрж░рж┐ржорж╛ржг:</label>
                            <input 
                              type="number" 
                              min="1" 
                              value={quantity}
                              onChange={(e) => handleQuantityChange(med.name, e.target.value)}
                            />
                          </div>
                          <div className="price-info">
                            <div>рз│{price} x {quantity}</div>
                            <div className="total-price">рз│{price * quantity}</div>
                          </div>
                        </div>
                      ) : (
                        <div className="unavailable-info">
                          <span className="unavailable-badge">тЭМ рж╕рзНржЯржХрзЗ ржирзЗржЗ</span>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>

              <div className="order-summary">
                <div className="summary-row">
                  <span>{t.subtotal}:</span>
                  <span>рз│{calculateSubtotal(selectedShop.id)}</span>
                </div>
                <div className="summary-row">
                  <span>{t.deliveryCharge}:</span>
                  <span>рз│{selectedShop.deliveryCharge}</span>
                </div>
                <div className="summary-row total">
                  <span><strong>{t.grandTotal}:</strong></span>
                  <span><strong>рз│{calculateGrandTotal(selectedShop.id)}</strong></span>
                </div>
              </div>

              <div className="order-actions">
                <button 
                  className="back-to-dashboard-btn"
                  onClick={onGoBack}
                >
                  тЖР ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржбрзЗ ржлрж┐рж░рзЗ ржпрж╛ржи
                </button>
                <button 
                  className="proceed-btn"
                  onClick={handleProceedToOrder}
                >
                  ЁЯЫТ {t.proceedToOrder}
                </button>
              </div>
            </div>
          </div>
        )}

        {!selectedShop && (
          <div className="select-shop-message">
            <div className="message-card">
              <h3>ЁЯУЭ {t.selectToOrder}</h3>
              <p>ржЙржкрж░рзЗрж░ ржжрзЛржХрж╛ржиржЧрзБрж▓рж┐ ржерзЗржХрзЗ ржПржХржЯрж┐ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

export default MedicineShops;
